let value = {
	"F2JQVO3AWEMK": {
		"tier": "1",
		"giftcode": "F2JQVO3AWEMK"
	},
	"Q44CN6ES9OFC": {
		"tier": "1",
		"giftcode": "Q44CN6ES9OFC"
	},
	"JVO1TO56WP05": {
		"tier": "1",
		"giftcode": "JVO1TO56WP05"
	},
	"MJHFNK2ZN2HU": {
		"tier": "1",
		"giftcode": "MJHFNK2ZN2HU"
	},
	"SY25PW0GCWTN": {
		"tier": "1",
		"giftcode": "SY25PW0GCWTN"
	},
	"R93MGML5G73Z": {
		"tier": "1",
		"giftcode": "R93MGML5G73Z"
	},
	"GBHL21BY91QU": {
		"tier": "1",
		"giftcode": "GBHL21BY91QU"
	},
	"HZDTBNFU2VMJ": {
		"tier": "1",
		"giftcode": "HZDTBNFU2VMJ"
	},
	"Q1VW4AYP3OV2": {
		"tier": "1",
		"giftcode": "Q1VW4AYP3OV2"
	},
	"U2K2M6THKMVA": {
		"tier": "1",
		"giftcode": "U2K2M6THKMVA"
	},
	"G1CMHCK5YNC5": {
		"tier": "1",
		"giftcode": "G1CMHCK5YNC5"
	},
	"BMW2OCLBZU01": {
		"tier": "1",
		"giftcode": "BMW2OCLBZU01"
	},
	"DGQD15Q0URR8": {
		"tier": "1",
		"giftcode": "DGQD15Q0URR8"
	},
	"CL6GQOSRAE3S": {
		"tier": "1",
		"giftcode": "CL6GQOSRAE3S"
	},
	"WKBY08OE7GOY": {
		"tier": "1",
		"giftcode": "WKBY08OE7GOY"
	},
	"YGU3MA28QD3S": {
		"tier": "1",
		"giftcode": "YGU3MA28QD3S"
	},
	"GEBLGGO081T4": {
		"tier": "1",
		"giftcode": "GEBLGGO081T4"
	},
	"Z4V51UMQUMRW": {
		"tier": "1",
		"giftcode": "Z4V51UMQUMRW"
	},
	"DZN0T75DLY96": {
		"tier": "1",
		"giftcode": "DZN0T75DLY96"
	},
	"FP4DDB3HDFEA": {
		"tier": "1",
		"giftcode": "FP4DDB3HDFEA"
	},
	"PBDK6AYDVFDB": {
		"tier": "1",
		"giftcode": "PBDK6AYDVFDB"
	},
	"RKSCB3N96RGP": {
		"tier": "1",
		"giftcode": "RKSCB3N96RGP"
	},
	"0BOSEGT4TM9P": {
		"tier": "1",
		"giftcode": "0BOSEGT4TM9P"
	},
	"CQ4MQA0D66NZ": {
		"tier": "1",
		"giftcode": "CQ4MQA0D66NZ"
	},
	"MMM6JAYQR1GW": {
		"tier": "1",
		"giftcode": "MMM6JAYQR1GW"
	},
	"JJ5GOWKMJV7Y": {
		"tier": "1",
		"giftcode": "JJ5GOWKMJV7Y"
	},
	"OYZVS0719RDH": {
		"tier": "1",
		"giftcode": "OYZVS0719RDH"
	},
	"UVQ1JME97KWB": {
		"tier": "1",
		"giftcode": "UVQ1JME97KWB"
	},
	"PFLTAP3UUUAH": {
		"tier": "1",
		"giftcode": "PFLTAP3UUUAH"
	},
	"BWZOFU662RBD": {
		"tier": "1",
		"giftcode": "BWZOFU662RBD"
	},
	"YOQ7YE5MZ7VW": {
		"tier": "1",
		"giftcode": "YOQ7YE5MZ7VW"
	},
	"VWZJJYZLM0P6": {
		"tier": "1",
		"giftcode": "VWZJJYZLM0P6"
	},
	"9FPLQLHB0TCZ": {
		"tier": "1",
		"giftcode": "9FPLQLHB0TCZ"
	},
	"L1YCW7N2FPTE": {
		"tier": "1",
		"giftcode": "L1YCW7N2FPTE"
	},
	"S3G050WBSCM8": {
		"tier": "1",
		"giftcode": "S3G050WBSCM8"
	},
	"R7BP9ADNS20V": {
		"tier": "1",
		"giftcode": "R7BP9ADNS20V"
	},
	"JRFGM236WBEB": {
		"tier": "1",
		"giftcode": "JRFGM236WBEB"
	},
	"JVRQ97ACS6O0": {
		"tier": "1",
		"giftcode": "JVRQ97ACS6O0"
	},
	"Y96HWOMKK33B": {
		"tier": "1",
		"giftcode": "Y96HWOMKK33B"
	},
	"FWPSENKDG0ZL": {
		"tier": "1",
		"giftcode": "FWPSENKDG0ZL"
	},
	"D84TF4JAEUDG": {
		"tier": "1",
		"giftcode": "D84TF4JAEUDG"
	},
	"TMUG52YYCZAY": {
		"tier": "1",
		"giftcode": "TMUG52YYCZAY"
	},
	"ZR8RZ27O35JN": {
		"tier": "1",
		"giftcode": "ZR8RZ27O35JN"
	},
	"BF911U91FFUK": {
		"tier": "1",
		"giftcode": "BF911U91FFUK"
	},
	"JGBZLFMP3GPT": {
		"tier": "1",
		"giftcode": "JGBZLFMP3GPT"
	},
	"OPMHGAT6PH9L": {
		"tier": "1",
		"giftcode": "OPMHGAT6PH9L"
	},
	"1DH829M07857": {
		"tier": "1",
		"giftcode": "1DH829M07857"
	},
	"QAECBQWTG5KR": {
		"tier": "1",
		"giftcode": "QAECBQWTG5KR"
	},
	"1BT1YOSHT1VY": {
		"tier": "1",
		"giftcode": "1BT1YOSHT1VY"
	},
	"7EYQ74VAKH6K": {
		"tier": "1",
		"giftcode": "7EYQ74VAKH6K"
	},
	"MSKEH3O3YR0Y": {
		"tier": "2",
		"giftcode": "MSKEH3O3YR0Y"
	},
	"RZ1GK2LGMGE9": {
		"tier": "2",
		"giftcode": "RZ1GK2LGMGE9"
	},
	"KDVW5RMUWKD8": {
		"tier": "2",
		"giftcode": "KDVW5RMUWKD8"
	},
	"8W7WU1U38RG4": {
		"tier": "2",
		"giftcode": "8W7WU1U38RG4"
	},
	"OWGALS1S94N4": {
		"tier": "2",
		"giftcode": "OWGALS1S94N4"
	},
	"8C03Z9LVW7HQ": {
		"tier": "2",
		"giftcode": "8C03Z9LVW7HQ"
	},
	"SLCKAOLL33S6": {
		"tier": "2",
		"giftcode": "SLCKAOLL33S6"
	},
	"GTOJ8DMYO7UJ": {
		"tier": "2",
		"giftcode": "GTOJ8DMYO7UJ"
	},
	"MDN33CTOCKW3": {
		"tier": "2",
		"giftcode": "MDN33CTOCKW3"
	},
	"H3JQB41DB48A": {
		"tier": "2",
		"giftcode": "H3JQB41DB48A"
	},
	"KY4BGB3S0U93": {
		"tier": "2",
		"giftcode": "KY4BGB3S0U93"
	},
	"QGCY4AA01DC5": {
		"tier": "2",
		"giftcode": "QGCY4AA01DC5"
	},
	"2TZA77K961H2": {
		"tier": "2",
		"giftcode": "2TZA77K961H2"
	},
	"OH0E8BSB7OJZ": {
		"tier": "2",
		"giftcode": "OH0E8BSB7OJZ"
	},
	"AF3JPSEYTZ87": {
		"tier": "2",
		"giftcode": "AF3JPSEYTZ87"
	},
	"4327OGQCVYZF": {
		"tier": "2",
		"giftcode": "4327OGQCVYZF"
	},
	"9ZGGNGKKS377": {
		"tier": "2",
		"giftcode": "9ZGGNGKKS377"
	},
	"PGR82VSCUP6L": {
		"tier": "2",
		"giftcode": "PGR82VSCUP6L"
	},
	"61VAPP483BFC": {
		"tier": "2",
		"giftcode": "61VAPP483BFC"
	},
	"SE8E7APM4M7H": {
		"tier": "2",
		"giftcode": "SE8E7APM4M7H"
	},
	"AJW5JRHDW07S": {
		"tier": "2",
		"giftcode": "AJW5JRHDW07S"
	},
	"NU6QVGMOP4WO": {
		"tier": "2",
		"giftcode": "NU6QVGMOP4WO"
	},
	"BUTHU1BGOY7V": {
		"tier": "2",
		"giftcode": "BUTHU1BGOY7V"
	},
	"PSUQH2AM74VS": {
		"tier": "2",
		"giftcode": "PSUQH2AM74VS"
	},
	"WDZG2DW0Y2ES": {
		"tier": "2",
		"giftcode": "WDZG2DW0Y2ES"
	},
	"2WSZNJ4COFK5": {
		"tier": "2",
		"giftcode": "2WSZNJ4COFK5"
	},
	"0CMT8UAR6P23": {
		"tier": "2",
		"giftcode": "0CMT8UAR6P23"
	},
	"DNWSK8DAET3F": {
		"tier": "2",
		"giftcode": "DNWSK8DAET3F"
	},
	"31J1Z5EQQT2B": {
		"tier": "2",
		"giftcode": "31J1Z5EQQT2B"
	},
	"D5OJNGSFUPVK": {
		"tier": "2",
		"giftcode": "D5OJNGSFUPVK"
	},
	"RVMAUU76FGMA": {
		"tier": "2",
		"giftcode": "RVMAUU76FGMA"
	},
	"4TBTUTZR62DH": {
		"tier": "2",
		"giftcode": "4TBTUTZR62DH"
	},
	"KGD94M1NHMZK": {
		"tier": "2",
		"giftcode": "KGD94M1NHMZK"
	},
	"OBVC5EY2NYLS": {
		"tier": "2",
		"giftcode": "OBVC5EY2NYLS"
	},
	"MZAOVG234JN1": {
		"tier": "2",
		"giftcode": "MZAOVG234JN1"
	},
	"GY38W4OOHBVR": {
		"tier": "2",
		"giftcode": "GY38W4OOHBVR"
	},
	"KKZEGYA7D76R": {
		"tier": "2",
		"giftcode": "KKZEGYA7D76R"
	},
	"ZR8D96JL91YJ": {
		"tier": "2",
		"giftcode": "ZR8D96JL91YJ"
	},
	"37TC0ULGTLLU": {
		"tier": "2",
		"giftcode": "37TC0ULGTLLU"
	},
	"AN1YO8DGN3WV": {
		"tier": "2",
		"giftcode": "AN1YO8DGN3WV"
	},
	"VMUKHYC6FJ8C": {
		"tier": "2",
		"giftcode": "VMUKHYC6FJ8C"
	},
	"EZYR4Y0GE9R3": {
		"tier": "2",
		"giftcode": "EZYR4Y0GE9R3"
	},
	"BYK1QMOT5RAN": {
		"tier": "2",
		"giftcode": "BYK1QMOT5RAN"
	},
	"S8Z001KAMEDN": {
		"tier": "2",
		"giftcode": "S8Z001KAMEDN"
	},
	"8FYJS7YH6F5D": {
		"tier": "2",
		"giftcode": "8FYJS7YH6F5D"
	},
	"P8RF3TNDH5OW": {
		"tier": "2",
		"giftcode": "P8RF3TNDH5OW"
	},
	"35H399F27JY8": {
		"tier": "2",
		"giftcode": "35H399F27JY8"
	},
	"9OZZU01N1GRR": {
		"tier": "2",
		"giftcode": "9OZZU01N1GRR"
	},
	"HREZ4267BWH7": {
		"tier": "2",
		"giftcode": "HREZ4267BWH7"
	},
	"CY3VD82U40ZM": {
		"tier": "2",
		"giftcode": "CY3VD82U40ZM"
	},
	"SH5PTJ382EFG": {
		"tier": "3",
		"giftcode": "SH5PTJ382EFG"
	},
	"VALWUFFKTHQW": {
		"tier": "3",
		"giftcode": "VALWUFFKTHQW"
	},
	"L4QYULJCK0F0": {
		"tier": "3",
		"giftcode": "L4QYULJCK0F0"
	},
	"MO66QD0CSTRM": {
		"tier": "3",
		"giftcode": "MO66QD0CSTRM"
	},
	"LNVJK5CYRKWW": {
		"tier": "3",
		"giftcode": "LNVJK5CYRKWW"
	},
	"6VVSEJ2QGWKY": {
		"tier": "3",
		"giftcode": "6VVSEJ2QGWKY"
	},
	"AQ1YNPA9177Z": {
		"tier": "3",
		"giftcode": "AQ1YNPA9177Z"
	},
	"LWPKLDETBTGC": {
		"tier": "3",
		"giftcode": "LWPKLDETBTGC"
	},
	"58S7BTFN9FOK": {
		"tier": "3",
		"giftcode": "58S7BTFN9FOK"
	},
	"FCAF7U9ZNO2P": {
		"tier": "3",
		"giftcode": "FCAF7U9ZNO2P"
	},
	"FHLGJ9HH0QSD": {
		"tier": "3",
		"giftcode": "FHLGJ9HH0QSD"
	},
	"JQC31DZJ382Y": {
		"tier": "3",
		"giftcode": "JQC31DZJ382Y"
	},
	"RQ9DPH0QR08N": {
		"tier": "3",
		"giftcode": "RQ9DPH0QR08N"
	},
	"UTTC5OHSQ16T": {
		"tier": "3",
		"giftcode": "UTTC5OHSQ16T"
	},
	"8G0QCZ38J7PY": {
		"tier": "3",
		"giftcode": "8G0QCZ38J7PY"
	},
	"42JSJHNO717K": {
		"tier": "3",
		"giftcode": "42JSJHNO717K"
	},
	"7LVOZTDM94V5": {
		"tier": "3",
		"giftcode": "7LVOZTDM94V5"
	},
	"SAFM1QTEODE6": {
		"tier": "3",
		"giftcode": "SAFM1QTEODE6"
	},
	"VK38HKNCV1T8": {
		"tier": "3",
		"giftcode": "VK38HKNCV1T8"
	},
	"ZSG1ARNYDM9A": {
		"tier": "3",
		"giftcode": "ZSG1ARNYDM9A"
	},
	"J8247TT67LBG": {
		"tier": "3",
		"giftcode": "J8247TT67LBG"
	},
	"EQ5TASSCSDOB": {
		"tier": "3",
		"giftcode": "EQ5TASSCSDOB"
	},
	"AYMH4SLY7FZP": {
		"tier": "3",
		"giftcode": "AYMH4SLY7FZP"
	},
	"5G34EPO4YKGM": {
		"tier": "3",
		"giftcode": "5G34EPO4YKGM"
	},
	"1PWBL31PFAQT": {
		"tier": "3",
		"giftcode": "1PWBL31PFAQT"
	},
	"SUBCKN91NFZL": {
		"tier": "3",
		"giftcode": "SUBCKN91NFZL"
	},
	"B8Y6HHHMVA27": {
		"tier": "3",
		"giftcode": "B8Y6HHHMVA27"
	},
	"P5KJQ5ME9CKB": {
		"tier": "3",
		"giftcode": "P5KJQ5ME9CKB"
	},
	"2M3GPSUWK2WS": {
		"tier": "3",
		"giftcode": "2M3GPSUWK2WS"
	},
	"82G5KZBV6EN2": {
		"tier": "3",
		"giftcode": "82G5KZBV6EN2"
	},
	"RY4ZUS5Z50OF": {
		"tier": "3",
		"giftcode": "RY4ZUS5Z50OF"
	},
	"MED1DG12G3S8": {
		"tier": "3",
		"giftcode": "MED1DG12G3S8"
	},
	"QBQU0DZD1B4N": {
		"tier": "3",
		"giftcode": "QBQU0DZD1B4N"
	},
	"V8H7DK22OCEF": {
		"tier": "3",
		"giftcode": "V8H7DK22OCEF"
	},
	"ZA3JMUT8FU64": {
		"tier": "3",
		"giftcode": "ZA3JMUT8FU64"
	},
	"ARAH59LHQAJ8": {
		"tier": "3",
		"giftcode": "ARAH59LHQAJ8"
	},
	"U39499ZG1ZOP": {
		"tier": "3",
		"giftcode": "U39499ZG1ZOP"
	},
	"1W6MHKL46WRO": {
		"tier": "3",
		"giftcode": "1W6MHKL46WRO"
	},
	"HEM5VB2RT6JD": {
		"tier": "3",
		"giftcode": "HEM5VB2RT6JD"
	},
	"U8QSE97SDJZ2": {
		"tier": "3",
		"giftcode": "U8QSE97SDJZ2"
	},
	"F9EB7SG66S8O": {
		"tier": "3",
		"giftcode": "F9EB7SG66S8O"
	},
	"AV93UPY3PNK8": {
		"tier": "3",
		"giftcode": "AV93UPY3PNK8"
	},
	"6WUS65ORHUBN": {
		"tier": "3",
		"giftcode": "6WUS65ORHUBN"
	},
	"V3040OYT7BJG": {
		"tier": "3",
		"giftcode": "V3040OYT7BJG"
	},
	"P08KCKBPQT9Q": {
		"tier": "3",
		"giftcode": "P08KCKBPQT9Q"
	},
	"JBU2WZ6CMNKL": {
		"tier": "3",
		"giftcode": "JBU2WZ6CMNKL"
	},
	"WURCUTH00TUC": {
		"tier": "3",
		"giftcode": "WURCUTH00TUC"
	},
	"P82LG7OD3OG8": {
		"tier": "3",
		"giftcode": "P82LG7OD3OG8"
	},
	"KN2ANZ42MUMT": {
		"tier": "3",
		"giftcode": "KN2ANZ42MUMT"
	},
	"QJ9EQ69DAOC3": {
		"tier": "3",
		"giftcode": "QJ9EQ69DAOC3"
	}
};
let historyData = [];
let analyst = {
  Total: 0,
  win: 0,
  lost: 0,
  items1: 0,
  items2: 0,
  items3: 0,
  items4: 0,
  items5: 0,
  items6: 0,
  items7: 0,
};

const eventData = localStorage.getItem("eventData");
if (eventData) {
  const ObjectData = JSON.parse(eventData);
  value = ObjectData;
}

const eventPlayerData = localStorage.getItem("eventPlayerData");
if (eventPlayerData) {
  const ObjectData = JSON.parse(eventPlayerData);
  historyData = ObjectData;
  UpdateHistory();
}
const eventAnalystData = localStorage.getItem("eventAnalystData");
if (eventAnalystData) {
  const ObjectData = JSON.parse(eventAnalystData);
  analyst = ObjectData;
}

const rewardsData = [
  [1, "Voucher giảm 10%"],
  [2, "Voucher giảm 20%"],
  [3, "Voucher giảm 30%"],
  [4, "Voucher giảm 40%"],
  [5, "Voucher giảm 50%"],
  [6, "Small food or drink"],
  [7, "Chúc bạn may mắn lần sau"],
];
// Epic
const tier1 = [
  [7, 26],
  [1, 21],
  [2, 17],
  [3, 14],
  [4, 10],
  [5, 7],
  [6, 5],
];
// Rare
const tier2 = [
  [7, 40],
  [1, 30],
  [2, 20],
  [3, 10],
];
// Legendary
const tier3 = [
  [2, 35],
  [3, 25],
  [4, 20],
  [5, 15],
  [6, 5],
];

function GetGiftcode() {
  let mssv = document.getElementById("mssv").value.toUpperCase();
  let giftcode = document.getElementById("giftcode").value;

  if (mssv == "" || giftcode == "") {
    Swal.fire({
      icon: "error",
      title: "Oops...",
      text: "Bạn cần điền đầy đủ thông tin",
    });
    return;
  }
  let valid = false;
  let data = {};
  for (const items in value) {
    if (items == giftcode || items == giftcode.toUpperCase()) {
      valid = true;
      data = value[items];
      break;
    }
  }
  if (valid) {
    const tier = data.tier;
    let result = "";
    let resultImage = "";

    const lastThreeEntries = historyData
      .filter((entry) => entry.mssv === mssv)
      .slice(0, 2);
    const activateInsurance =
      lastThreeEntries.length === 2 &&
      lastThreeEntries.every(
        (entry) => entry.reward === "Chúc bạn may mắn lần sau"
      );
    let insurance = false;

    switch (tier) {
      case "1":
        result = weightedRandom(tier1);
        break;
      case "2":
        result = weightedRandom(tier2);
        break;
      case "3":
        result = weightedRandom(tier3);
        break;
      default:
        Swal.fire({
          icon: "error",
          title: "ERROR!",
          text: `Không tìm thấy tier phần thường cho giftcode ${giftcode}`,
        });
        break;
    }

    if (activateInsurance && result == 7) {
      insurance = true;
    }

    resultImage = result + ".png";
    let resultMessage = "";

    for (const [id, reward] of rewardsData) {
      if (id == result) {
        resultMessage = reward;
        break;
      }
    }

    document.getElementById("mssv").value = "";
    document.getElementById("giftcode").value = "";

    delete value[data.giftcode];
    const JsonData = JSON.stringify(value);
    localStorage.setItem("eventData", JsonData);

    let player = {};
    player = {
      mssv: mssv,
      giftcode: data.giftcode,
      reward: resultMessage,
    };
    historyData.unshift(player);
    if (insurance) {
      player = {
        mssv: mssv,
        giftcode: "BẢO HIỂM",
        reward: "Voucher giảm 10%",
      };
      historyData.unshift(player);
    }

    localStorage.setItem("eventPlayerData", JSON.stringify(historyData));
    UpdateHistory();

    switch (result) {
      case 1:
        analyst.items1++;
        analyst.win++;
        break;
      case 2:
        analyst.items2++;
        analyst.win++;
        break;
      case 3:
        analyst.items3++;
        analyst.win++;
        break;
      case 4:
        analyst.items4++;
        analyst.win++;
        break;
      case 5:
        analyst.items5++;
        analyst.win++;
        break;
      case 6:
        analyst.items6++;
        analyst.win++;
        break;
      case 7:
        analyst.items7++;
        analyst.lost++;
        break;
      default:
        break;
    }
    analyst.Total++;
    localStorage.setItem("eventAnalystData", JSON.stringify(analyst));

    Swal.fire({
      title: "Bạn đã nhận được",
      html: `<img class="img-rewards" src="../Image/Rewards/${resultImage}">`,
    });
    setTimeout(() => {
      if (insurance) {
        Swal.fire({
          title: "Bạn đã nhận bảo hiểm từ chương trình",
          text: "Do bạn đã không trúng 3 lần liên tiếp nên chúng tôi đã cho bạn một bảo hiểm",
          html: `<img class="img-rewards" src="../Image/Rewards/1.png">`,
        });
      }
    }, 2000);
  } else {
    Swal.fire({
      icon: "error",
      title: "Oops...",
      text: "Giftcode đã được sử dụng hoặc không tồn tại",
    });
  }
}

function weightedRandom(items) {
  const totalWeight = items.reduce((sum, item) => sum + item[1], 0);
  let random = Math.random() * totalWeight;

  for (let item of items) {
    if (random < item[1]) {
      return item[0];
    }
    random -= item[1];
  }
}

function UpdateHistory() {
  const history_show = document.getElementById("history-show");
  history_show.innerHTML = "";
  historyData.forEach((items) => {
    const HTMLStructure = `<tr>
                                <td>${items.mssv}</td>
                                <td>${items.giftcode}</td>
                                <td>${items.reward}</td>
                            </tr>`;
    history_show.innerHTML += HTMLStructure;
  });
}
